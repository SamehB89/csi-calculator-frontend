<!-- Cache bust: 2025-12-17 19:30:00 -->
<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crew Calculator - CSI Data Manager</title>
    <meta name="description" content="Calculate crew requirements and productivity for construction activities">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5429423113977975" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="css/theme.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/crew-calculator.css">
    <link rel="stylesheet" href="css/lang-toggle.css">
    <link rel="stylesheet" href="css/ads.css">
    <link rel="stylesheet" href="css/cost-calculator.css">
    <link rel="stylesheet" href="css/quick-search.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="js/i18n.js?v=3"></script>
    <script src="js/ads.js"></script>
    <script src="js/cost-calculator.js?v=2"></script>
    <script src="js/quick-search.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>

<body>
    <nav class="navbar">
        <div class="container">
            <a href="index.html" class="logo-container">
                <img src="assets/csi_logo_v2.png" alt="SAMEH Logo" class="logo-image">
                <span class="logo-text">CSI Calculator</span>
            </a>
            <div class="nav-links">
                <a href="index.html" data-i18n="home" data-icon="ğŸ ">
                    <span>Browse</span>
                </a>
                <a href="crew-calculator.html" class="active" data-i18n="crewCalculator" data-icon="ğŸ§®">
                    <span>Calculator</span>
                </a>
                <a href="ai-planner.html" data-i18n="aiPlanner" data-icon="ğŸ¤–">
                    <span>AI Planner</span>
                </a>
                <a href="evm-calculator.html" data-i18n="evmCalculator" data-icon="ğŸ“Š">
                    <span>EVM Calculator</span>
                </a>
                <a href="blog/" data-i18n="blog" data-icon="ğŸ“š">
                    <span>Knowledge Bites</span>
                </a>
                <button id="themeToggle" class="theme-toggle" onclick="toggleTheme()" title="Toggle Theme">
                    ğŸŒ™
                </button>
                <button id="langToggle" class="lang-toggle" onclick="toggleLanguage()">
                    <span id="langIcon">EN</span>
                </button>
            </div>
        </div>
    </nav>

    <div class="calculator-container">
        <h2 class="page-title" data-i18n="pageTitle">âš¡ Ø­Ø§Ø³Ø¨Ø© ÙØ±ÙŠÙ‚ Ø§Ù„Ø¹Ù…Ù„ ÙˆØ§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ©</h2>

        <!-- Quick Search Section -->
        <div class="search-container" id="quickSearchContainer">
            <div class="search-box-wrapper">
                <div class="search-box">
                    <span class="search-icon">ğŸ”</span>
                    <input 
                        type="text" 
                        id="quickSearchInput"
                        class="search-input"
                        placeholder="Ø§ÙƒØªØ¨ ÙˆØµÙ Ø§Ù„Ø¹Ù†ØµØ± Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ© (Item Description) Ù…Ø«Ù„ Raft, Column, Plaster... Ø§Ù„Ø®"
                        autocomplete="off"
                        data-i18n-placeholder="quickSearchPlaceholder"
                    >
                    <button id="clearSearch" class="clear-btn" style="display:none;" title="Clear search">
                        <span>âŒ</span>
                    </button>
                </div>
                
                <!-- Search Results Dropdown -->
                <div id="searchResults" class="search-results" style="display:none;">
                    <!-- Dynamic results will appear here -->
                </div>
            </div>
            
            <div class="search-or-divider">
                <span data-i18n="orSelectFromSections">Ø£Ùˆ Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</span>
            </div>
        </div>

        <!-- Step 1: Division Selection -->
        <div class="section-card glass-card">
            <div class="section-header">
                <h3><span data-i18n="divisionSelection">ğŸ” Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ù‡Ø±Ù…ÙŠ</span></h3>
                <p class="section-subtitle" data-i18n="divisionSelectionSubtitle">Ø§Ø®ØªØ± Ø§Ù„ØªÙ‚Ø³ÙŠÙ…Ø§Øª Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ù†ØµØ±
                    Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</p>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label for="mainDivision">
                        <span class="label-icon">1ï¸âƒ£</span>
                        <span data-i18n="mainDivision">Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Main Division)</span>
                    </label>
                    <select id="mainDivision" class="form-select" onchange="loadSubDivision1()">
                        <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="subDivision1">
                        <span class="label-icon">2ï¸âƒ£</span>
                        <span data-i18n="subDivision1">Ø§Ù„Ù‚Ø³Ù… Ø§Ù„ÙØ±Ø¹ÙŠ Ø§Ù„Ø£ÙˆÙ„ (Sub-Division 1)</span>
                    </label>
                    <select id="subDivision1" class="form-select" onchange="loadSubDivision2()" disabled>
                        <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… Ø§Ù„ÙØ±Ø¹ÙŠ Ø§Ù„Ø£ÙˆÙ„ --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="subDivision2">
                        <span class="label-icon">3ï¸âƒ£</span>
                        <span data-i18n="subDivision2">Ø§Ù„Ù‚Ø³Ù… Ø§Ù„ÙØ±Ø¹ÙŠ Ø§Ù„Ø«Ø§Ù†ÙŠ (Sub-Division 2)</span>
                    </label>
                    <select id="subDivision2" class="form-select" onchange="loadItems()" disabled>
                        <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… Ø§Ù„ÙØ±Ø¹ÙŠ Ø§Ù„Ø«Ø§Ù†ÙŠ --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="itemDescription">
                        <span class="label-icon">4ï¸âƒ£</span>
                        <span data-i18n="itemDescription">ÙˆØµÙ Ø§Ù„Ø¹Ù†ØµØ± (Item Description)</span>
                    </label>
                    <select id="itemDescription" class="form-select" onchange="loadItemDetails()" disabled>
                        <option value="">-- Ø§Ø®ØªØ± ÙˆØµÙ Ø§Ù„Ø¹Ù†ØµØ± --</option>
                    </select>
                </div>
        </div>

        <!-- Step 2: Item Details Display -->
        <div id="itemDetailsSection" class="section-card glass-card" style="display: none;">
            <div class="section-header">
                <h3><span data-i18n="itemDetails">ğŸ“Š ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù†ØµØ±</span></h3>
            </div>

            <div class="item-info-grid">
                <div class="info-card">
                    <div class="info-icon">ğŸ“ˆ</div>
                    <div class="info-content">
                        <span class="info-label" data-i18n="dailyOutput">Ø§Ù„Ø¥Ù†ØªØ§Ø¬ Ø§Ù„ÙŠÙˆÙ…ÙŠ</span>
                        <span class="info-value" id="dailyOutput">--</span>
                        <span class="info-unit" id="dailyOutputUnit"></span>
                    </div>
                </div>

                <div class="info-card">
                    <div class="info-icon">ğŸ‘·</div>
                    <div class="info-content">
                        <span class="info-label" data-i18n="manHours">Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„</span>
                        <span class="info-value" id="manHours">--</span>
                        <span class="info-unit" data-i18n="perUnit">Ø³Ø§Ø¹Ø©/ÙˆØ­Ø¯Ø©</span>
                    </div>
                </div>

                <div class="info-card">
                    <div class="info-icon">ğŸšœ</div>
                    <div class="info-content">
                        <span class="info-label" data-i18n="equipHours">Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ø¹Ø¯Ø§Øª</span>
                        <span class="info-value" id="equipHours">--</span>
                        <span class="info-unit" data-i18n="perUnit">Ø³Ø§Ø¹Ø©/ÙˆØ­Ø¯Ø©</span>
                    </div>
                </div>

                <div class="info-card full-width crew-structure-card">
                    <div class="info-icon">ğŸ‘¥</div>
                    <div class="info-content">
                        <span class="info-label crew-structure-title" data-i18n="crewStructure">ØªØ±ÙƒÙŠØ¨Ø© Ø§Ù„ÙØ±ÙŠÙ‚</span>
                        <div class="crew-structure-inline" id="crewStructureInline">--</div>
                    </div>
                </div>
            </div>

            <!-- Crew Details Table -->
            <div class="crew-details-section">
                <h4><span data-i18n="crewDetailsTitle">ğŸ‘¥ ØªÙØ§ØµÙŠÙ„ Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„ÙØ±ÙŠÙ‚</span></h4>
                <div class="table-wrapper">
                    <table class="crew-table" id="crewDetailsTable">
                        <thead>
                            <tr>
                                <th data-i18n="crewMember">Crew Member</th>
                                <th data-i18n="quantity">Quantity</th>
                                <th data-i18n="descriptionAndRole">Ø§Ù„ÙˆØµÙ ÙˆØ§Ù„ÙˆØ¸ÙŠÙØ©</th>
                            </tr>
                        </thead>
                        <tbody id="crewTableBody">
                            <!-- Will be populated dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Step 3: Quantity Input -->
        <div id="quantitySection" class="section-card glass-card" style="display: none;">
            <div class="section-header">
                <h3><span data-i18n="quantityInput">ğŸ”¢ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙ…ÙŠØ©</span></h3>
            </div>

            <div class="quantity-input-grid">
                <div class="form-group">
                    <label for="quantity" data-i18n="requiredQuantity">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</label>
                    <input type="number" id="quantity" class="form-input" data-i18n-placeholder="enterQuantity" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙ…ÙŠØ©"
                        min="0" step="0.01">
                    <span class="input-unit" id="quantityUnit"></span>
                </div>

                <div class="form-group">
                    <label for="hoursPerDay" data-i18n="hoursPerDay">Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</label>
                    <input type="number" id="hoursPerDay" class="form-input" value="8" min="1" max="24" step="0.5">
                    <span class="input-unit" data-i18n="hourPerDay">Ø³Ø§Ø¹Ø©/ÙŠÙˆÙ…</span>
                </div>

                <div class="form-group">
                    <label for="numberOfCrews" data-i18n="numberOfCrews">Ø¹Ø¯Ø¯ ÙØ±Ù‚ Ø§Ù„Ø¹Ù…Ù„</label>
                    <input type="number" id="numberOfCrews" class="form-input" value="1" min="1" step="1">
                    <span class="input-unit" data-i18n="crew">ÙØ±ÙŠÙ‚</span>
                </div>
            </div>

            <button class="btn btn-primary calculate-btn" onclick="calculateCrew()">
                <span class="btn-icon">ğŸ§®</span>
                <span data-i18n="calculateBtn">Ø§Ø­Ø³Ø¨ Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„ÙØ±ÙŠÙ‚ ÙˆØ§Ù„Ù…Ø¯Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© Ù„Ù„Ù†Ø´Ø§Ø·</span>
            </button>
        </div>

        <!-- Step 4: Results -->
        <div id="resultsSection" class="section-card glass-card" style="display: none;">
            <div class="section-header">
                <h3><span data-i18n="results">âœ… Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</span></h3>
            </div>

            <div id="resultsContent">
                <!-- Results will be populated here -->
            </div>

            <!-- Button to show cost calculator -->
            <button id="showCostBtn" class="btn btn-primary calculate-btn" onclick="showCostSection()" style="margin-top: 1rem; display: none;">
                <span class="btn-icon">ğŸ’°</span>
                <span data-i18n="calculateDetailedCost">Ø§Ø­Ø³Ø¨ Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©</span>
            </button>
        </div>

        <!-- Step 5: Cost Calculator (NEW!) -->
        <div id="costSection" class="section-card glass-card" style="display: none;">
            <div class="section-header">
                <h3><span data-i18n="costCalculatorTitle">ğŸ’° Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©</span></h3>
                <p class="section-subtitle" data-i18n="enterMarketPrices">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„ÙØ¹Ù„ÙŠØ© Ù…Ù† Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ù…Ø­Ù„ÙŠ</p>
            </div>
                <div class="cost-category" id="currencySection">
                    <label data-i18n="currencyLabel" class="input-label">Ø§Ù„Ø¹Ù…Ù„Ø©</label>
                    <select id="currencySelect" class="cost-input">
                        <option value="EGP" data-i18n="currencyEGP">Ø¬.Ù….</option>
                        <option value="USD" data-i18n="currencyUSD">Ø¯ÙˆÙ„Ø§Ø± Ø£Ù…Ø±ÙŠÙƒÙŠ</option>
                        <option value="EUR" data-i18n="currencyEUR">ÙŠÙˆØ±Ùˆ</option>
                        <option value="GBP" data-i18n="currencyGBP">Ø¬Ù†ÙŠÙ‡ Ø¥Ø³ØªØ±Ù„ÙŠÙ†ÙŠ</option>
                        <option value="CNY" data-i18n="currencyCNY">ÙŠÙˆØ§Ù† ØµÙŠÙ†ÙŠ</option>
                        <option value="SAR" data-i18n="currencySAR">Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ</option>
                        <option value="KWD" data-i18n="currencyKWD">Ø¯ÙŠÙ†Ø§Ø± ÙƒÙˆÙŠØªÙŠ</option>
                        <option value="QAR" data-i18n="currencyQAR">Ø±ÙŠØ§Ù„ Ù‚Ø·Ø±ÙŠ</option>
                        <option value="OTHER" data-i18n="currencyOther">Other</option>
                    </select>
                    <input type="text" id="customCurrency" class="cost-input hidden" placeholder="" data-i18n-placeholder="currencyOther" />
                </div>

            <!-- Labor Costs -->
            <div class="cost-category">
                <h4 data-i18n="laborCostTitle">ğŸ‘· ØªÙƒÙ„ÙØ© Ø§Ù„Ø¹Ù…Ø§Ù„Ø©</h4>
                <p class="category-note" data-i18n="laborCostNote">Ø£Ø¯Ø®Ù„ Ø³Ø¹Ø± Ø§Ù„ÙŠÙˆÙ… Ø§Ù„ÙˆØ§Ø­Ø¯ Ù„ÙƒÙ„ Ù†ÙˆØ¹ Ø¹Ø§Ù…Ù„</p>
                <div id="laborCostInputs" class="cost-inputs-grid">
                    <!-- Will be populated dynamically based on crew results -->
                </div>
                <div class="subtotal-row">
                    <span data-i18n="laborSubtotal">Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙƒÙ„ÙØ© Ø§Ù„Ø¹Ù…Ø§Ù„Ø©:</span>
                    <span id="laborTotalCost" class="subtotal-value">0 Ø¬.Ù…</span>
                </div>
            </div>

            <!-- Equipment Costs -->
            <div class="cost-category">
                <h4 data-i18n="equipmentCostTitle">ğŸšœ ØªÙƒÙ„ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª</h4>
                <p class="category-note" data-i18n="equipmentCostNote">Ø£Ø¯Ø®Ù„ Ø³Ø¹Ø± Ø§Ù„Ø³Ø§Ø¹Ø© Ø§Ù„ÙˆØ§Ø­Ø¯Ø© Ù„ÙƒÙ„ Ù…Ø¹Ø¯Ø©</p>
                <div id="equipmentCostInputs" class="cost-inputs-grid">
                    <!-- Will be populated dynamically based on equipment results -->
                </div>
                <div class="subtotal-row">
                    <span data-i18n="equipmentSubtotal">Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙƒÙ„ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª:</span>
                    <span id="equipmentTotalCost" class="subtotal-value">0 Ø¬.Ù…</span>
                </div>
            </div>

            <!-- Materials (Optional) -->
            <div class="cost-category materials-section">
                <label class="checkbox-label">
                    <input type="checkbox" id="includeMaterials" onchange="toggleMaterialsSection()">
                    <span data-i18n="materialsTitle">ğŸ“¦ Ø¥Ø¶Ø§ÙØ© ØªÙƒÙ„ÙØ© Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span>
                </label>
                <div id="materialsCostSection" style="display: none;">
                    <p class="category-note" data-i18n="materialsNote">Ø£Ø¯Ø®Ù„ ØªÙƒÙ„ÙØ© Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù… Ù„Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©</p>
                    <div class="cost-input-item material-input">
                        <label>
                            <span class="input-label" data-i18n="materialsInputLabel">ØªÙƒÙ„ÙØ© Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©</span>
                            <span class="input-hint" id="materialsHint"></span>
                        </label>
                        <div class="input-with-unit">
                            <input type="number" id="materialsCost" class="cost-input" placeholder="0" min="0" oninput="calculateTotalCost()">
                            <span class="unit">Ø¬.Ù…</span>
                        </div>
                    </div>
                </div>
                <div class="subtotal-row" id="materialsSubtotalRow" style="display: none;">
                    <span data-i18n="materialsSubtotal">Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙƒÙ„ÙØ© Ø§Ù„Ù…ÙˆØ§Ø¯:</span>
                    <span id="materialsTotalCost" class="subtotal-value">0 Ø¬.Ù…</span>
                </div>
            </div>

            <!-- Profit & Tax -->
            <div class="cost-category modifiers-section">
                <h4 data-i18n="modifiersTitle">ğŸ“Š Ù‡Ø§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­ ÙˆØ§Ù„Ø¶Ø±Ø§Ø¦Ø¨</h4>
                <div class="modifiers-grid">
                    <div class="modifier-item">
                        <label data-i18n="profitMarginLabel">Ù‡Ø§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­ (%)</label>
                        <input type="number" id="profitMargin" class="cost-input" value="15" min="0" max="100" oninput="calculateTotalCost()">
                    </div>
                    <div class="modifier-item">
                        <label data-i18n="vatRateLabel">Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ© (%)</label>
                        <input type="number" id="vatRate" class="cost-input" value="14" min="0" max="100" oninput="calculateTotalCost()">
                    </div>
                </div>
            </div>

            <!-- Cost Summary -->
            <div class="cost-summary">
                <h4 data-i18n="costSummaryTitle">ğŸ“‹ Ù…Ù„Ø®Øµ Ø§Ù„ØªÙƒÙ„ÙØ©</h4>
                <div class="summary-grid">
                    <div class="summary-line">
                        <span data-i18n="summaryLabor">ØªÙƒÙ„ÙØ© Ø§Ù„Ø¹Ù…Ø§Ù„Ø©:</span>
                        <span id="summaryLabor">0 Ø¬.Ù…</span>
                    </div>
                    <div class="summary-line">
                        <span data-i18n="summaryEquipment">ØªÙƒÙ„ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª:</span>
                        <span id="summaryEquipment">0 Ø¬.Ù…</span>
                    </div>
                    <div class="summary-line" id="summaryMaterialsRow" style="display: none;">
                        <span data-i18n="summaryMaterials">ØªÙƒÙ„ÙØ© Ø§Ù„Ù…ÙˆØ§Ø¯:</span>
                        <span id="summaryMaterials">0 Ø¬.Ù…</span>
                    </div>
                    <div class="summary-line summary-subtotal">
                        <span data-i18n="summaryBaseCost">Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©:</span>
                        <span id="summaryBaseCost">0 Ø¬.Ù…</span>
                    </div>
                    <div class="summary-line">
                        <span><span data-i18n="summaryProfit">Ù‡Ø§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­</span> (<span id="profitPercent">15</span>%):</span>
                        <span id="summaryProfit">0 Ø¬.Ù…</span>
                    </div>
                    <div class="summary-line">
                        <span data-i18n="summaryBeforeVat">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©:</span>
                        <span id="summaryBeforeVat">0 Ø¬.Ù…</span>
                    </div>
                    <div class="summary-line">
                        <span><span data-i18n="summaryVat">Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ©</span> (<span id="vatPercent">14</span>%):</span>
                        <span id="summaryVat">0 Ø¬.Ù…</span>
                    </div>
                    
                    <!-- New Overall Cost Row -->
                    <div class="summary-line summary-subtotal">
                         <span data-i18n="summaryOverallCost">Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©:</span>
                         <span id="summaryOverallCost">0 Ø¬.Ù…</span>
                    </div>

                    <div class="summary-line summary-total">
                        <span>ğŸ’¸ <span data-i18n="grandTotal">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</span></span>
                        <span id="summaryGrandTotal">0 Ø¬.Ù…</span>
                    </div>
                    <div class="summary-line unit-price">
                        <span data-i18n="unitPrice">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©:</span>
                        <span id="summaryUnitPrice">0 Ø¬.Ù…/<span id="unitLabel">ÙˆØ­Ø¯Ø©</span></span>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="cost-actions">
                <button class="btn btn-primary" onclick="generateCostPDF()">
                    <span class="btn-icon">ğŸ“„</span>
                    <span data-i18n="exportPDF">ØªØµØ¯ÙŠØ± PDF</span>
                </button>
                <button class="btn btn-secondary" onclick="savePricesToStorage()">
                    <span class="btn-icon">ğŸ’¾</span>
                    <span data-i18n="savePrices">Ø­ÙØ¸ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</span>
                </button>
                <button class="btn btn-outline" onclick="loadSavedPrices()">
                    <span class="btn-icon">ğŸ“¥</span>
                    <span data-i18n="loadPrices">Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</span>
                </button>
                <button class="btn btn-danger" onclick="clearAllPrices()">
                    <span class="btn-icon">ğŸ—‘ï¸</span>
                    <span data-i18n="clearPrices">Ù…Ø³Ø­ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</span>
                </button>
            </div>
        </div>

        <!-- Error Display -->
        <div id="errorMessage" class="error-message" style="display: none;"></div>
    </div>

    <script>
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const isVercel = window.location.hostname.includes('vercel.app');
        const isMobileApp = window.location.protocol === 'https:' && window.location.hostname === 'localhost';

        const API_BASE = isLocalhost ? 'http://localhost:5000/api' 
            : (isVercel || isMobileApp) ? 'https://csicalcbackendv3.pythonanywhere.com/api'
            : '/api';
            
        console.log('ğŸ”§ Configured API_BASE:', API_BASE);
        
        let currentItemData = null;
        // Shared variable for cost calculator
        window.currentCrewResults = null;

        // Theme Toggle
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            const btn = document.getElementById('themeToggle');
            btn.textContent = newTheme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
        }

        window.addEventListener('load', () => {
            // Load saved theme
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            const btn = document.getElementById('themeToggle');
            if (btn) btn.textContent = savedTheme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
            
            loadMainDivisions();
            applyLanguage();
        });

        async function loadMainDivisions() {
            try {
                const response = await fetch(`${API_BASE}/divisions`);
                const divisions = await response.json();

                const select = document.getElementById('mainDivision');
                select.innerHTML = `<option value="">${t('selectMainDivision')}</option>`;

                divisions.forEach(div => {
                    const option = document.createElement('option');
                    option.value = div.code;
                    option.textContent = `${div.code} - ${div.name}`;
                    select.appendChild(option);
                });
            } catch (error) {
                showError('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©: ' + error.message);
            }
        }

        async function loadSubDivision1() {
            const mainCode = document.getElementById('mainDivision').value;
            const sub1Select = document.getElementById('subDivision1');
            const sub2Select = document.getElementById('subDivision2');
            const itemSelect = document.getElementById('itemDescription');

            sub1Select.innerHTML = `<option value="">${t('selectSubDivision1')}</option>`;
            sub2Select.innerHTML = `<option value="">${t('selectSubDivision2')}</option>`;
            itemSelect.innerHTML = `<option value="">${t('selectItem')}</option>`;
            sub1Select.disabled = true;
            sub2Select.disabled = true;
            itemSelect.disabled = true;
            hideItemDetails();

            if (!mainCode) return;

            try {
                const response = await fetch(`${API_BASE}/subdivisions1?main_code=${mainCode}`);
                const subdivisions = await response.json();

                subdivisions.forEach(sub => {
                    if (sub.code && sub.name) {
                        const option = document.createElement('option');
                        option.value = sub.code;
                        option.textContent = `${sub.code} - ${sub.name}`;
                        sub1Select.appendChild(option);
                    }
                });

                sub1Select.disabled = false;
            } catch (error) {
                showError('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ÙØ±Ø¹ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰: ' + error.message);
            }
        }

        async function loadSubDivision2() {
            const sub1Code = document.getElementById('subDivision1').value;
            const sub2Select = document.getElementById('subDivision2');
            const itemSelect = document.getElementById('itemDescription');
            const mainCode = document.getElementById('mainDivision').value;

            sub2Select.innerHTML = `<option value="">${t('selectSubDivision2')}</option>`;
            itemSelect.innerHTML = `<option value="">${t('selectItem')}</option>`;
            sub2Select.disabled = true;
            itemSelect.disabled = true;
            hideItemDetails();

            if (!sub1Code) return;

            try {
                const response = await fetch(`${API_BASE}/subdivisions2?sub1_code=${sub1Code}&main_code=${mainCode}`);
                const subdivisions = await response.json();

                subdivisions.forEach(sub => {
                    if (sub.code && sub.name) {
                        const option = document.createElement('option');
                        option.value = sub.code;
                        option.textContent = `${sub.code} - ${sub.name}`;
                        sub2Select.appendChild(option);
                    }
                });

                sub2Select.disabled = false;
            } catch (error) {
                showError('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ÙØ±Ø¹ÙŠØ© Ø§Ù„Ø«Ø§Ù†ÙŠØ©: ' + error.message);
            }
        }

        async function loadItems() {
            const sub2Code = document.getElementById('subDivision2').value;
            const itemSelect = document.getElementById('itemDescription');

            itemSelect.innerHTML = `<option value="">${t('selectItem')}</option>`;
            itemSelect.disabled = true;
            hideItemDetails();

            if (!sub2Code) return;

            try {
                const response = await fetch(`${API_BASE}/items?sub2_code=${sub2Code}`);
                const data = await response.json();
                
                let itemsList = [];
                if (Array.isArray(data)) {
                    itemsList = data;
                } else if (data && Array.isArray(data.items)) {
                    itemsList = data.items;
                }

                itemsList.forEach(item => {
                    if (item.description) {
                        const option = document.createElement('option');
                        option.value = item.full_code; // Use full_code for uniqueness
                        option.textContent = item.description;
                        option.dataset.fullCode = item.full_code;
                        itemSelect.appendChild(option);
                    }
                });

                itemSelect.disabled = false;
            } catch (error) {
                showError('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ±: ' + error.message);
            }
        }

        async function loadItemDetails() {
            const itemCode = document.getElementById('itemDescription').value;

            if (!itemCode) {
                hideItemDetails();
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/item-details?full_code=${encodeURIComponent(itemCode)}`);
                currentItemData = await response.json();

                displayItemDetails(currentItemData);
            } catch (error) {
                showError('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù†ØµØ±: ' + error.message);
            }
        }

        function displayItemDetails(data) {
            document.getElementById('itemDetailsSection').style.display = 'block';
            document.getElementById('quantitySection').style.display = 'block';

            document.getElementById('dailyOutput').textContent = data.productivity.daily_output || '--';
            document.getElementById('dailyOutputUnit').textContent = data.item.unit ? `${data.item.unit}/${t('day')}` : '';
            document.getElementById('manHours').textContent = data.productivity.man_hours || '--';
            document.getElementById('equipHours').textContent = data.productivity.equip_hours || '--';

            if (data.crew_details && data.crew_details.length > 0) {
                const laborCrew = [];
                const equipmentCrew = [];

                data.crew_details.forEach(crew => {
                    const crewLine = `${crew.quantity} Ã— ${crew.description}`;
                    const isEquipment = ['crane', 'truck', 'pump', 'vibrator', 'tool',
                        'dozer', 'loader', 'excavator', 'mixer', 'compressor']
                        .some(word => crew.description.toLowerCase().includes(word));

                    if (isEquipment) {
                        equipmentCrew.push(crewLine);
                    } else {
                        laborCrew.push(crewLine);
                    }
                });

                let crewHtml = '';
                if (laborCrew.length > 0) {
                    crewHtml += laborCrew.map(line => `<div class="crew-line">${line}</div>`).join('');
                }
                if (laborCrew.length > 0 && equipmentCrew.length > 0) {
                    crewHtml += '<hr class="crew-separator">';
                }
                if (equipmentCrew.length > 0) {
                    crewHtml += equipmentCrew.map(line => `<div class="crew-line">${line}</div>`).join('');
                }

                document.getElementById('crewStructureInline').innerHTML = crewHtml;
            } else {
                document.getElementById('crewStructureInline').textContent = '--';
            }

            document.getElementById('quantityUnit').textContent = data.item.unit || '';

            const tbody = document.getElementById('crewTableBody');
            tbody.innerHTML = '';

            if (data.crew_details && data.crew_details.length > 0) {
                data.crew_details.forEach(crew => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="crew-number">Crew Member no.${crew.crew_number}</td>
                        <td class="crew-qty">${crew.quantity}</td>
                        <td class="crew-desc">${crew.description}</td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = `<tr><td colspan="3" class="no-data">${t('noCrewData')}</td></tr>`;
            }

            document.getElementById('itemDetailsSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function hideItemDetails() {
            document.getElementById('itemDetailsSection').style.display = 'none';
            document.getElementById('quantitySection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'none';
        }

        async function calculateCrew() {
            const quantity = parseFloat(document.getElementById('quantity').value);
            const hoursPerDay = parseFloat(document.getElementById('hoursPerDay').value);
            const numberOfCrews = parseInt(document.getElementById('numberOfCrews').value);

            if (!quantity || quantity <= 0) {
                showError(t('invalidQuantity'));
                return;
            }

            if (!numberOfCrews || numberOfCrews < 1) {
                showError(t('invalidCrews'));
                return;
            }

            if (!currentItemData) {
                showError(t('noItemSelected'));
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/calculate-crew`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        item_code: currentItemData.item.full_code,
                        quantity: quantity,
                        hours_per_day: hoursPerDay,
                        number_of_crews: numberOfCrews
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    showError(error.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª');
                    return;
                }

                const results = await response.json();
                displayResults(results);

                document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                showError('ÙØ´Ù„ Ø­Ø³Ø§Ø¨ Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„ÙØ±ÙŠÙ‚: ' + error.message);
            }
        }

        function displayResults(data) {
            const resultsSection = document.getElementById('resultsSection');
            const resultsContent = document.getElementById('resultsContent');

            const html = `
                <div class="results-grid">
                    <div class="result-card">
                        <div class="result-icon">ğŸ‘¥</div>
                        <div class="result-content">
                            <span class="result-label">${t('numberOfCrewsResult')}</span>
                            <span class="result-value">${data.input.number_of_crews}</span>
                            <span class="result-unit">${t('crew')}</span>
                        </div>
                    </div>

                    <div class="result-card">
                        <div class="result-icon">ğŸ“ˆ</div>
                        <div class="result-content">
                            <span class="result-label">${t('totalDailyOutput')}</span>
                            <span class="result-value">${data.calculations.adjusted_daily_output.toFixed(2)}</span>
                            <span class="result-unit">${data.item.unit}${t('perDay')}</span>
                        </div>
                    </div>
                    
                    <div class="result-card">
                        <div class="result-icon">â±ï¸</div>
                        <div class="result-content">
                            <span class="result-label">${t('totalDays')}</span>
                            <span class="result-value">${data.calculations.total_days.toFixed(2)}</span>
                            <span class="result-unit">${t('day')}</span>
                        </div>
                    </div>
                    
                    <div class="result-card">
                        <div class="result-icon">ğŸ‘·</div>
                        <div class="result-content">
                            <span class="result-label">${t('totalManHours')}</span>
                            <span class="result-value">${data.calculations.total_man_hours.toFixed(2)}</span>
                            <span class="result-unit">${t('hour')}</span>
                        </div>
                    </div>
                    
                    <div class="result-card">
                        <div class="result-icon">ğŸšœ</div>
                        <div class="result-content">
                            <span class="result-label">${t('totalEquipHours')}</span>
                            <span class="result-value">${data.calculations.total_equip_hours.toFixed(2)}</span>
                            <span class="result-unit">${t('hour')}</span>
                        </div>
                    </div>
                    
                    <div class="result-card">
                        <div class="result-icon">ğŸ‘¤</div>
                        <div class="result-content">
                            <span class="result-label">${t('totalLabor')}</span>
                            <span class="result-value">${data.crew.total_labor_count}</span>
                            <span class="result-unit">${t('worker')}</span>
                        </div>
                    </div>
                </div>
                
                <div class="crew-breakdown">
                    <h4>ğŸ‘· ${t('laborBreakdown')}</h4>
                    <table class="crew-table">
                        <thead>
                            <tr>
                                <th>${t('position')}</th>
                                <th>${t('count')}</th>
                                <th>${t('totalHours')}</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.crew.labor.map(member => `
                                <tr>
                                    <td>${member.position}</td>
                                    <td>${member.count}</td>
                                    <td>${member.total_hours.toFixed(2)} ${t('hour')}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                
                ${data.crew.equipment.length > 0 ? `
                    <div class="crew-breakdown">
                        <h4>ğŸšœ ${t('equipmentBreakdown')}</h4>
                        <table class="crew-table">
                            <thead>
                                <tr>
                                    <th>${t('equipment')}</th>
                                    <th>${t('count')}</th>
                                    <th>${t('operatingHours')}</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.crew.equipment.map(equip => `
                                    <tr>
                                        <td>${equip.position}</td>
                                        <td>${equip.count}</td>
                                        <td>${equip.total_hours.toFixed(2)} ${t('hour')}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                ` : ''}
            `;

            resultsContent.innerHTML = html;
            resultsSection.style.display = 'block';

            // Store results for cost calculator
            window.currentCrewResults = data;

            // Show cost button
            document.getElementById('showCostBtn').style.display = 'inline-flex';
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = 'âš ï¸ ' + message;
            errorDiv.style.display = 'block';

            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
    </script>
</body>

</html>